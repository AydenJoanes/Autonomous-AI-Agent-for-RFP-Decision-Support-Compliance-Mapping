# **PHASE 6 — Agent Cognition, Reflection & Learning (Refined Plan)**

**Phase 6 Goal:**  
**Introduce agent cognition (memory, reflection, clarification, learning signals) without autonomy or mutation, while preparing clean foundations for future autonomous behavior.**

**Phase 6 is observational, evaluative, and gated — not self-modifying.**

---

## **Phase 6 Outputs (What Exists at the End)**

* **Recommendations are persisted with outcomes**  
* **Agent can reflect on its own decisions**  
* **Agent can ask clarification questions**  
* **System collects calibration metrics (no live tuning)**  
* **Similar past recommendations can be retrieved**  
* **Learning is explicitly gated (cold-start safe)**

---

## **STEP 0 — Preconditions (Assumed Done)**

* **Phase 5 RecommendationService is stable**  
* **`recommendations` table already exists**  
* **pgvector is already in use for similarity**  
* **DecisionEngine produces traceable outputs**

---

## **STEP 1 — Schema Extension (Memory Without New Tables)**

### **Objective**

**Store decision outcomes, reflections, embeddings, and learning signals using the existing `recommendations` table.**

### **Functional Logic**

* **Each recommendation becomes a memory record**  
* **Memory is append-only**  
* **No duplication, no separate “memory” tables**

### **Files Involved**

* **`schema.py`**  
* **`migrations/`**

### **Data Stored**

* **Outcome status (WON / LOST / NO\_BID\_CONFIRMED / UNKNOWN)**  
* **Outcome timestamp**  
* **Reflection notes (JSON)**  
* **Clarification questions (JSON)**  
* **Recommendation embedding (for similarity)**  
* **Calibration metrics snapshot (JSON)**

### **Checklist**

* **Extend `recommendations` table only**  
* **No new memory tables created**  
* **Outcome fields nullable**  
* **Reflection fields optional**  
* **Embedding column added**  
* **Migration applied cleanly**

**Add an explicit database migration reference for Phase 6 schema changes.**  
 **All new Phase 6 columns must be introduced via a versioned migration, not inline schema edits.**

### **Files involved**

* **`schema.py` — extend existing `recommendations` table**

* **`migrations/versions/add_phase6_columns.py` — migration script**

### **Columns introduced (already approved by feedback)**

* **`outcome_status`**

* **`outcome_recorded_at`**

* **`outcome_notes`**

* **`reflection_notes`**

* **`calibration_metrics` (JSON)**

* **`embedding` (vector)**

### **Checklist (add under Step 1\)**

**Migration file created and referenced in plan**

**Migration only adds columns, no table creation**

**Migration reversible (downgrade path defined)**

**Schema and migration kept in sync**

---

## **STEP 2 — Outcome Recording Service**

### **Objective**

**Persist real-world outcomes for recommendations after the fact.**

### **Functional Logic**

* **Outcomes are external inputs (manual or API)**  
* **System never infers outcomes on its own**  
* **Outcomes unlock learning later**

### **Files**

* **`services/outcome_service.py`**  
* **`api/routes/outcomes.py`**

### **Behavior**

* **Attach outcome to an existing recommendation**  
* **Timestamp outcome**  
* **Freeze historical decision data**

### **Checklist**

* **Outcome update requires recommendation ID**  
* **Outcome status validated**  
* **Outcome cannot overwrite decision fields**  
* **Audit-safe updates only**

---

## **STEP 3 — Reflection Engine (Read-Only Cognition)**

### **Objective**

**Enable the agent to analyze its own decisions without changing them.**

### **Functional Logic**

* **Reflection runs after recommendation is generated**  
* **Reflection inspects:**  
  * **Decision**  
  * **Confidence**  
  * **Compliance summary**  
  * **Risks**  
* **Outputs structured reflection notes**

### **Files**

* **`services/reflection_engine.py`**

### **Reflection Outputs**

* **Decision rationale gaps**  
* **Uncertainty signals**  
* **Missing or weak evidence**  
* **Overconfidence indicators**

### **Checklist**

* **Reflection does not modify recommendation**  
* **Reflection stored with recommendation**  
* **Reflection runs deterministically**  
* **Reflection failure does not block output**

---

## **STEP 4 — Clarification Question Generator**

### **Objective**

**Generate non-blocking clarification questions when uncertainty is detected.**

### **Functional Logic**

* **Triggered by reflection signals**  
* **Questions are suggestions, not requirements**  
* **Recommendation still returned immediately**

### **Files**

* **`services/clarification_generator.py`**

### **Output Examples**

* **Missing certification proof**  
* **Ambiguous timeline constraints**  
* **Budget uncertainty**  
* **Unclear data availability**

### **Checklist**

* **Clarification questions optional**  
* **Questions stored with recommendation**  
* **No blocking behavior**  
* **Questions are human-readable**

---

## **STEP 5 — Learning Gatekeeper (Cold-Start Protection)**

### **Objective**

**Prevent any learning or adjustment until enough real outcomes exist.**

### **Functional Logic**

* **Learning is disabled by default**  
* **Gatekeeper checks:**  
  * **Minimum number of outcomes**  
  * **Outcome diversity**  
  * **Data freshness**

### **Files**

* **`services/learning_gatekeeper.py`**

### **Rules**

* **Learning allowed only if:**  
  * **≥ N outcomes recorded**  
  * **Mixed outcomes (not all wins/losses)**  
* **Otherwise → metrics only, no updates**

### **Checklist**

* **Gatekeeper evaluated before learning**  
* **Learning disabled if thresholds unmet**  
* **Reason logged when learning blocked**  
* **No side effects if blocked**

---

## **STEP 6 — Memory Query & Similarity Search**

### **Objective**

**Allow the agent to retrieve similar past recommendations.**

### **Functional Logic**

* **Use pgvector similarity on recommendation embeddings**  
* **Same pattern as project similarity**  
* **Read-only access**

### **Files**

* **`repositories/recommendation_repository.py`**

### **Use Cases**

* **Context for reflection**  
* **Human review support**  
* **Future autonomy groundwork**

### **Checklist**

* **Reuse pgvector**  
* **No new vector store**  
* **Similarity threshold configurable**  
* **Read-only queries only**

---

## **STEP 7 — Calibration Metrics Collector (No Adjustment)**

### **Objective**

**Measure confidence quality without modifying behavior.**

### **Metrics Collected**

* **Brier Score**  
* **Expected Calibration Error (ECE)**  
* **Over/Under-confidence Ratio**

### **Functional Logic**

* **Metrics computed when outcomes exist**  
* **Stored per recommendation**  
* **Aggregated over time**

### **Files**

* **`services/calibration_metrics.py`**

### **Checklist**

* **Metrics computed only when outcome exists**  
* **Metrics stored, not acted upon**  
* **Metrics versioned by model version**  
* **No confidence adjustment yet**

**Store calibration metrics directly on the existing `recommendations` record to preserve one-to-one traceability between a recommendation and its confidence quality.**

### **Storage decision (explicit)**

**`recommendations.calibration_metrics  (JSON)`**

### **What goes inside `calibration_metrics`**

* **brier\_score**

* **expected\_calibration\_error**

* **overconfidence\_ratio**

* **model\_version**

* **computed\_at**

### **Constraints (important)**

* **Metrics are read-only**

* **Metrics do not modify confidence**

* **Metrics are ignored by DecisionEngine**

### **Checklist (add under Step 7\)**

**Metrics computed only when outcome exists**

**Metrics stored in `recommendations.calibration_metrics`**

**Metrics versioned by model version**

**No downstream logic consumes metrics yet**

---

## **STEP 8 — Orchestrator Wrapper (Non-Invasive)**

### **Objective**

**Coordinate Phase 6 components without modifying Phase 5 flow.**

### **Functional Logic**

* **Wraps RecommendationService**  
* **Hooks:**  
  * **After recommendation → reflection**  
  * **After reflection → clarification**  
  * **After outcome → metrics**  
* **No control loops**

### **Files**

* **`services/phase6_orchestrator.py`**

### **Checklist**

* **Orchestrator is optional dependency**  
* **Phase 5 works without it**  
* **Execution order fixed**  
* **No recursive calls**

### **What to add (instruction)**

**Add a Non-Blocking Enhancement subsection under Step 8\.**

### **Instruction to include**

**After a recommendation is finalized, optionally generate a semantic embedding representing the recommendation for future similarity queries. This does not affect decision logic.**

### **Embedding source text (explicit)**

* **justification text**

* **concatenated risk descriptions**

### **Storage**

**`recommendations.embedding`**

### **Constraints**

* **Generated after recommendation is finalized**

* **Failure to embed must not fail the request**

* **No similarity search required in Phase 6**

### **Checklist (optional under Step 8\)**

**Embedding generated post-decision only**

**Embedding stored on recommendation record**

**Failure does not block recommendation**

**No behavioral dependency on embedding**

---

## **STEP 9 — API Extensions (Minimal & Safe)**

### **Objective**

**Expose Phase 6 capabilities without opening dangerous controls.**

### **Endpoints**

* **Record outcome**  
* **Fetch similar recommendations**  
* **Fetch reflections & questions**  
* **Health check**

### **Files**

* **`api/routes/recommendation.py` (extended)**  
* **`api/routes/outcomes.py`**

### **Checklist**

* **No learning-trigger endpoints**  
* **No destructive routes**  
* **Read/write separation clear**  
* **Rate-limiting optional**

---

## **STEP 10 — Evaluation & Regression Tests**

### **Objective**

**Ensure Phase 6 does not break Phase 5\.**

### **Functional Logic**

* **Snapshot Phase 5 outputs**  
* **Run Phase 6 additions**  
* **Compare decisions unchanged**

### **Files**

* **`tests/test_phase6_reflection.py`**  
* **`tests/test_phase6_metrics.py`**  
* **`tests/test_phase6_regression.py`**

### **Checklist**

* **Phase 5 outputs identical pre/post Phase 6**  
* **Reflection never mutates decisions**  
* **Metrics computed only when valid**  
* **Learning never activates prematurely**

---

# **Phase 6 Completion Criteria**

* **✅ Recommendations stored with outcomes**  
* **✅ Reflection and clarification generated**  
* **✅ Metrics collected (Brier, ECE, O/U)**  
* **✅ Similar recommendations retrievable**  
* **✅ No autonomy**  
* **✅ No learning updates**  
* **✅ Phase 5 remains untouched**